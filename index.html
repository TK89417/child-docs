<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Child Docs">
  <title>Child Documentation</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    #root { min-height: 100vh; }
    input[type="file"] { font-size: 16px; } /* Prevent zoom on iOS */
    @media (max-width: 640px) {
      .mobile-card { display: block !important; }
      .desktop-table { display: none !important; }
    }
    @media (min-width: 641px) {
      .mobile-card { display: none !important; }
      .desktop-table { display: block !important; }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
import React, { useState, useEffect, useRef } from 'react';
import { Download, FileText, Trash2, Search, Filter, Eye, Moon, Sun, Mic, MicOff, ArrowLeftRight } from 'lucide-react';

const ChildDocumentationApp = () => {
  const [entries, setEntries] = useState([]);
  const [currentEntry, setCurrentEntry] = useState(null);
  const [view, setView] = useState('list');
  const [selectedEntries, setSelectedEntries] = useState(new Set());
  const [searchTerm, setSearchTerm] = useState('');
  const [filterChild, setFilterChild] = useState('all');
  const [darkMode, setDarkMode] = useState(false);
  const [isRecording, setIsRecording] = useState(false);
  const [recordingField, setRecordingField] = useState(null);
  const recognitionRef = useRef(null);
  const [showComparison, setShowComparison] = useState(false);
  const [downloadMessage, setDownloadMessage] = useState('');
  const [annotatingPhoto, setAnnotatingPhoto] = useState(null); // {photoIndex: number, observationIndex: number}
  const canvasRef = useRef(null);
  const [isDrawing, setIsDrawing] = useState(false);
  const [drawColor, setDrawColor] = useState('#FF0000');
  const [drawTool, setDrawTool] = useState('arrow'); // 'arrow', 'circle', 'line'
  const [drawThickness, setDrawThickness] = useState(3);
  const [annotations, setAnnotations] = useState([]); // Store all drawn shapes

  const childDOBs = {
    'Benjamin': '2016-06-17',
    'Vincent': '2018-05-07'
  };

  const calculateAge = (dob, asOfDate) => {
    if (!dob || !asOfDate) return '';
    const birth = new Date(dob);
    const current = new Date(asOfDate);
    
    let years = current.getFullYear() - birth.getFullYear();
    let months = current.getMonth() - birth.getMonth();
    
    if (months < 0) {
      years--;
      months += 12;
    }
    
    return `${years} years, ${months} months`;
  };

  // Load dark mode preference or set based on time of day
  useEffect(() => {
    const savedDarkMode = localStorage.getItem('darkMode');
    let shouldBeDark = false;
    
    if (savedDarkMode !== null) {
      // User has a preference saved
      shouldBeDark = savedDarkMode === 'true';
    } else {
      // Auto-detect based on time of day (7 PM to 7 AM = dark mode)
      const hour = new Date().getHours();
      shouldBeDark = hour >= 19 || hour < 7;
    }
    
    setDarkMode(shouldBeDark);
    if (shouldBeDark) {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
  }, []);

  // Toggle dark mode
  const toggleDarkMode = () => {
    const newMode = !darkMode;
    setDarkMode(newMode);
    localStorage.setItem('darkMode', newMode.toString());
    if (newMode) {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
  };

  // Speech recognition setup
  useEffect(() => {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognitionRef.current = new SpeechRecognition();
      recognitionRef.current.continuous = true;
      recognitionRef.current.interimResults = true;

      recognitionRef.current.onresult = (event) => {
        const transcript = Array.from(event.results)
          .map(result => result[0])
          .map(result => result.transcript)
          .join('');

        if (recordingField && currentEntry) {
          if (recordingField.type === 'observation') {
            const updated = [...currentEntry.observations];
            updated[recordingField.index].observation = transcript;
            setCurrentEntry({ ...currentEntry, observations: updated });
          } else if (recordingField.type === 'childExplanation') {
            const updated = [...currentEntry.observations];
            updated[recordingField.index].childExplanation = transcript;
            setCurrentEntry({ ...currentEntry, observations: updated });
          } else if (recordingField.type === 'quickNotes') {
            setCurrentEntry({ ...currentEntry, quickNotes: transcript });
          } else if (recordingField.type === 'additionalObservations') {
            setCurrentEntry({ ...currentEntry, additionalObservations: transcript });
          }
        }
      };

      recognitionRef.current.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
        setIsRecording(false);
        setRecordingField(null);
      };

      recognitionRef.current.onend = () => {
        setIsRecording(false);
        setRecordingField(null);
      };
    }
  }, [currentEntry]);

  const startRecording = (fieldType, index = null) => {
    if (recognitionRef.current) {
      setRecordingField({ type: fieldType, index });
      setIsRecording(true);
      recognitionRef.current.start();
    } else {
      console.error('Speech recognition is not supported in your browser.');
    }
  };

  const stopRecording = () => {
    if (recognitionRef.current) {
      recognitionRef.current.stop();
      setIsRecording(false);
      setRecordingField(null);
    }
  };

  useEffect(() => {
    const saved = localStorage.getItem('childDocEntries');
    if (saved) {
      try {
        const parsed = JSON.parse(saved);
        setEntries(parsed);
      } catch (error) {
        console.error('Error loading entries:', error);
      }
    }
  }, []);

  useEffect(() => {
    if (entries.length > 0) {
      try {
        localStorage.setItem('childDocEntries', JSON.stringify(entries));
      } catch (error) {
        console.error('Error saving entries:', error);
      }
    }
  }, [entries]);

  const createNewEntry = () => {
    const now = new Date();
    const newEntry = {
      id: Date.now(),
      entryNumber: entries.length + 1,
      child: '',
      date: now.toISOString().split('T')[0],
      timestamp: now.toISOString(),
      context: '',
      contextOther: '',
      location: 'Home (Springfield, MO)',
      witnessPresent: '',
      childAge: '',
      quickNotes: '',
      observations: [],
      demeanor: [],
      photos: [],
      storageLocation: 'iCloud Drive',
      additionalObservations: '',
      loggedBy: 'Tamas Kiss',
      dateLogged: now.toISOString().split('T')[0],
      createdTimestamp: now.toISOString()
    };
    setCurrentEntry(newEntry);
    setView('form');
  };

  const addObservation = () => {
    setCurrentEntry({
      ...currentEntry,
      observations: [
        ...currentEntry.observations,
        { 
          bodyArea: '', 
          observation: '', 
          childAware: '',
          childExplanation: '', 
          childDemeanorDiscussing: [],
          parentKnowledge: '', 
          notes: '',
          annotatedPhoto: null
        }
      ]
    });
  };

  const updateObservation = (index, field, value) => {
    const updated = [...currentEntry.observations];
    updated[index][field] = value;
    setCurrentEntry({ ...currentEntry, observations: updated });
  };

  const removeObservation = (index) => {
    const updated = currentEntry.observations.filter((_, i) => i !== index);
    setCurrentEntry({ ...currentEntry, observations: updated });
  };

  const handlePhotoUpload = (e) => {
    const files = Array.from(e.target.files);
    const readers = files.map(file => {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (event) => {
          resolve({
            data: event.target.result,
            name: file.name,
            timestamp: new Date().toISOString(),
            size: file.size,
            type: file.type
          });
        };
        reader.readAsDataURL(file);
      });
    });

    Promise.all(readers).then(photos => {
      setCurrentEntry({
        ...currentEntry,
        photos: [...currentEntry.photos, ...photos]
      });
    });
  };

  const removePhoto = (index) => {
    const updated = currentEntry.photos.filter((_, i) => i !== index);
    setCurrentEntry({ ...currentEntry, photos: updated });
  };

  const openAnnotationModal = (photoIndex, observationIndex = null) => {
    setAnnotatingPhoto({ photoIndex, observationIndex });
    setDrawTool('arrow');
    setDrawColor('#FF0000');
    setDrawThickness(3);
    setAnnotations([]);
  };

  const saveAnnotatedPhoto = () => {
    if (!canvasRef.current || !annotatingPhoto) return;
    
    const canvas = canvasRef.current;
    const annotatedDataUrl = canvas.toDataURL('image/png');
    
    const photo = currentEntry.photos[annotatingPhoto.photoIndex];
    const updatedPhoto = {
      ...photo,
      data: annotatedDataUrl,
      annotated: true,
      originalData: photo.originalData || photo.data
    };
    
    const updatedPhotos = [...currentEntry.photos];
    updatedPhotos[annotatingPhoto.photoIndex] = updatedPhoto;
    
    setCurrentEntry({ ...currentEntry, photos: updatedPhotos });
    setAnnotatingPhoto(null);
  };

  const cancelAnnotation = () => {
    setAnnotatingPhoto(null);
  };

  const undoAnnotation = (photoIndex) => {
    const photo = currentEntry.photos[photoIndex];
    if (photo.originalData) {
      const updatedPhotos = [...currentEntry.photos];
      updatedPhotos[photoIndex] = {
        ...photo,
        data: photo.originalData,
        annotated: false
      };
      setCurrentEntry({ ...currentEntry, photos: updatedPhotos });
    }
  };

  const saveEntry = () => {
    const entryToSave = {
      ...currentEntry,
      timestamp: new Date().toISOString(),
      dateLogged: new Date().toISOString().split('T')[0]
    };
    
    if (entryToSave.id && entries.find(e => e.id === entryToSave.id)) {
      // Editing existing entry
      setEntries(entries.map(e => e.id === entryToSave.id ? entryToSave : e));
    } else {
      // New entry
      setEntries([...entries, entryToSave]);
    }
    setCurrentEntry(null);
    setView('list');
  };

  const editEntry = (entry) => {
    setCurrentEntry({ ...entry });
    setView('form');
  };

  const deleteEntry = (id) => {
    // Direct delete without confirm since it's in a sandboxed environment
    setEntries(entries.filter(e => e.id !== id));
    const newSelected = new Set(selectedEntries);
    newSelected.delete(id);
    setSelectedEntries(newSelected);
  };

  const toggleSelectEntry = (id) => {
    const newSelected = new Set(selectedEntries);
    if (newSelected.has(id)) {
      newSelected.delete(id);
    } else {
      newSelected.add(id);
    }
    setSelectedEntries(newSelected);
  };

  const generatePDF = (entriesToExport) => {
    if (!entriesToExport || entriesToExport.length === 0) {
      console.error('No entries selected for export.');
      return;
    }

    try {
      const htmlContent = generatePDFHTML(entriesToExport);
      
      // Generate filename based on entries
      const dateStr = new Date().toISOString().split('T')[0];
      const childName = entriesToExport[0]?.child || 'documentation';
      const filename = `${childName}-${dateStr}-${entriesToExport.length}entries.html`;
      
      // Create blob
      const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
      
      // Check if Web Share API is available (iOS/mobile)
      if (navigator.share && navigator.canShare && navigator.canShare({ files: [new File([blob], filename)] })) {
        // Use Web Share API for mobile (shows iOS share sheet)
        const file = new File([blob], filename, { type: 'text/html' });
        
        navigator.share({
          title: 'Child Documentation',
          text: `Documentation for ${childName}`,
          files: [file]
        })
        .then(() => {
          setDownloadMessage(`‚úì Shared: ${filename}. Save to Files ‚Üí iCloud Drive.`);
          setTimeout(() => setDownloadMessage(''), 5000);
          console.log('Successfully shared');
        })
        .catch((error) => {
          // User cancelled or error occurred, fallback to download
          console.log('Share cancelled or failed, using download instead:', error);
          downloadFile(blob, filename);
        });
      } else {
        // Desktop or browsers without share API - direct download
        downloadFile(blob, filename);
      }
      
    } catch (error) {
      console.error('PDF generation error:', error);
      setDownloadMessage('‚úó Export failed. Check console for details.');
      setTimeout(() => setDownloadMessage(''), 5000);
    }
  };

  const downloadFile = (blob, filename) => {
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Clean up
    setTimeout(() => URL.revokeObjectURL(url), 100);
    
    // Show success message
    setDownloadMessage(`‚úì Downloaded: ${filename}. Open it and press Ctrl+P to save as PDF.`);
    setTimeout(() => setDownloadMessage(''), 5000);
    
    console.log(`Downloaded: ${filename}`);
  };

  const generatePDFHTML = (entriesToExport) => {
    const includeIndex = entriesToExport.length > 1;
    
    let html = `
      <!DOCTYPE html>
      <html>
      <head>
        <title>Child Documentation Log</title>
        <style>
          @page { 
            size: letter; 
            margin: 0.5in 0.75in;
          }
          
          * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
          }
          
          body { 
            font-family: 'Helvetica Neue', Arial, sans-serif;
            font-size: 10pt;
            line-height: 1.5;
            color: #1a1a1a;
          }
          
          .page-break { 
            page-break-after: always; 
          }
          
          /* Header Styling */
          .document-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #2563eb;
          }
          
          .document-header h1 {
            font-size: 20pt;
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 5px;
            letter-spacing: 0.5px;
          }
          
          .document-header .entry-number {
            font-size: 11pt;
            color: #64748b;
            font-weight: 500;
          }
          
          /* Quick Notes Alert Box */
          .quick-notes-box {
            background: linear-gradient(to right, #fef3c7, #fef9e7);
            border-left: 4px solid #f59e0b;
            padding: 12px 15px;
            margin-bottom: 20px;
            border-radius: 4px;
          }
          
          .quick-notes-box strong {
            color: #92400e;
            font-size: 10pt;
          }
          
          .quick-notes-box p {
            color: #78350f;
            margin-top: 4px;
            font-size: 10pt;
          }
          
          /* Info Grid */
          .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px 20px;
            margin-bottom: 20px;
            background: #f8fafc;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
          }
          
          .info-item {
            display: flex;
            align-items: baseline;
          }
          
          .info-label {
            font-weight: 600;
            color: #475569;
            min-width: 120px;
            font-size: 9pt;
          }
          
          .info-value {
            color: #1e293b;
            font-weight: 500;
            font-size: 10pt;
          }
          
          .info-value.highlight {
            background: #dbeafe;
            padding: 2px 6px;
            border-radius: 3px;
            color: #1e40af;
          }
          
          /* Section Headers */
          .section {
            margin-bottom: 20px;
          }
          
          .section-header {
            background: linear-gradient(to right, #1e40af, #3b82f6);
            color: white;
            padding: 8px 12px;
            font-size: 11pt;
            font-weight: 600;
            margin-bottom: 12px;
            border-radius: 4px;
            letter-spacing: 0.3px;
          }
          
          /* Observations Table */
          .observations-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 9pt;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
          }
          
          .observations-table th {
            background: #1e40af;
            color: white;
            padding: 10px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 9pt;
            border: none;
          }
          
          .observations-table td {
            padding: 10px 8px;
            border: 1px solid #e2e8f0;
            background: white;
            vertical-align: top;
          }
          
          .observations-table tr:nth-child(even) td {
            background: #f8fafc;
          }
          
          .observations-table .body-area {
            font-weight: 600;
            color: #1e40af;
          }
          
          .observations-table .child-response {
            font-style: italic;
            color: #64748b;
            font-size: 8.5pt;
            margin-top: 3px;
          }
          
          .observations-table .awareness-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 8pt;
            font-weight: 600;
            margin-bottom: 4px;
          }
          
          .awareness-aware {
            background: #dbeafe;
            color: #1e40af;
          }
          
          .awareness-unaware {
            background: #e5e7eb;
            color: #4b5563;
          }
          
          /* Demeanor Section */
          .demeanor-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
          }
          
          .demeanor-chip {
            background: #ecfdf5;
            color: #065f46;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 9pt;
            font-weight: 500;
            border: 1px solid #a7f3d0;
          }
          
          /* Photo Grid */
          .photo-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 12px 0;
          }
          
          .photo-container {
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          }
          
          .photo-container img {
            width: 100%;
            height: auto;
            display: block;
          }
          
          .photo-caption {
            padding: 8px;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
            font-size: 8pt;
            color: #64748b;
          }
          
          .photo-caption strong {
            color: #1e293b;
          }
          
          /* Additional Observations */
          .additional-obs {
            background: #fefce8;
            border-left: 4px solid #eab308;
            padding: 12px 15px;
            border-radius: 4px;
            margin: 10px 0;
          }
          
          .additional-obs p {
            color: #713f12;
            font-size: 9.5pt;
            line-height: 1.6;
          }
          
          /* Footer */
          .document-footer {
            margin-top: 30px;
            padding-top: 15px;
            border-top: 2px solid #e2e8f0;
            font-size: 8.5pt;
            color: #64748b;
          }
          
          .footer-item {
            margin-bottom: 4px;
          }
          
          .footer-item strong {
            color: #475569;
          }
          
          .signature-line {
            margin-top: 40px;
            padding-top: 2px;
            border-top: 1px solid #1e293b;
            width: 250px;
            font-size: 9pt;
            color: #475569;
          }
          
          /* Index Page */
          .index-page {
            margin-bottom: 30px;
          }
          
          .index-page h1 {
            font-size: 22pt;
            color: #1e40af;
            margin-bottom: 20px;
            border-bottom: 3px solid #3b82f6;
            padding-bottom: 10px;
          }
          
          .index-meta {
            background: #f8fafc;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
          }
          
          .index-meta p {
            margin: 5px 0;
            font-size: 10pt;
          }
          
          .index-entry {
            background: white;
            margin: 12px 0;
            padding: 12px 15px;
            border-left: 4px solid #3b82f6;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
          }
          
          .index-entry strong {
            color: #1e40af;
            font-size: 11pt;
          }
          
          .index-entry-detail {
            color: #64748b;
            font-size: 9pt;
            margin-top: 4px;
          }
          
          /* Print optimizations */
          @media print {
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
          }
        </style>
      </head>
      <body>
    `;

    if (includeIndex) {
      html += `
        <div class="index-page">
          <h1>üìã Child Documentation Log - Index</h1>
          <div class="index-meta">
            <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
            <p><strong>Total Entries:</strong> ${entriesToExport.length}</p>
            <p><strong>Date Range:</strong> ${entriesToExport[0]?.date} to ${entriesToExport[entriesToExport.length - 1]?.date}</p>
            <p><strong>Maintained by:</strong> Tamas Kiss</p>
          </div>
          ${entriesToExport.map((entry) => `
            <div class="index-entry">
              <div><strong>Entry #${entry.entryNumber}</strong> - ${entry.child}</div>
              <div class="index-entry-detail">
                üìÖ ${entry.date} at ${new Date(entry.timestamp).toLocaleTimeString()} | 
                üìç ${entry.context}${entry.contextOther ? ` (${entry.contextOther})` : ''} | 
                üìä ${entry.observations.length} observation${entry.observations.length !== 1 ? 's' : ''} | 
                üì∑ ${entry.photos.length} photo${entry.photos.length !== 1 ? 's' : ''}
              </div>
              ${entry.quickNotes ? `<div class="index-entry-detail" style="margin-top: 6px; font-style: italic;">üí¨ ${entry.quickNotes}</div>` : ''}
            </div>
          `).join('')}
        </div>
        <div class="page-break"></div>
      `;
    }

    entriesToExport.forEach((entry, idx) => {
      const calculatedAge = entry.child && childDOBs[entry.child] ? 
        calculateAge(childDOBs[entry.child], entry.date) : entry.childAge;
      
      html += `
        <div class="document-header">
          <h1>Child Documentation Log</h1>
          <div class="entry-number">Entry #${entry.entryNumber}</div>
        </div>

        ${entry.quickNotes ? `
          <div class="quick-notes-box">
            <strong>‚ö†Ô∏è Quick Notes:</strong>
            <p>${entry.quickNotes}</p>
          </div>
        ` : ''}

        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">Child:</span>
            <span class="info-value highlight">${entry.child}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Age:</span>
            <span class="info-value">${calculatedAge || 'Not specified'}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Observation Date:</span>
            <span class="info-value">${entry.date}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Time Documented:</span>
            <span class="info-value">${new Date(entry.timestamp).toLocaleTimeString()}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Location:</span>
            <span class="info-value">${entry.location || 'Not specified'}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Context:</span>
            <span class="info-value">${entry.context}${entry.contextOther ? ` (${entry.contextOther})` : ''}</span>
          </div>
          ${entry.witnessPresent ? `
            <div class="info-item" style="grid-column: span 2;">
              <span class="info-label">Witness Present:</span>
              <span class="info-value">${entry.witnessPresent}</span>
            </div>
          ` : ''}
        </div>

        ${entry.observations.length > 0 ? `
          <div class="section">
            <div class="section-header">üìù Physical Observations</div>
            <table class="observations-table">
              <thead>
                <tr>
                  <th style="width: 15%">Body Area</th>
                  <th style="width: 30%">Description</th>
                  <th style="width: 35%">Child Response</th>
                  <th style="width: 10%">Parent Knowledge</th>
                  <th style="width: 10%">Notes</th>
                </tr>
              </thead>
              <tbody>
                ${entry.observations.map(obs => `
                  <tr>
                    <td class="body-area">${obs.bodyArea || '‚Äî'}</td>
                    <td>${obs.observation || '‚Äî'}</td>
                    <td>
                      ${obs.childAware === 'aware' ? '<span class="awareness-badge awareness-aware">Child Aware</span>' : 
                        obs.childAware === 'unaware' ? '<span class="awareness-badge awareness-unaware">Child Unaware</span>' : ''}
                      ${obs.childExplanation ? `<div class="child-response">"${obs.childExplanation}"</div>` : ''}
                      ${obs.childDemeanorDiscussing && obs.childDemeanorDiscussing.length > 0 ? 
                        `<div class="child-response">Demeanor: ${obs.childDemeanorDiscussing.join(', ')}</div>` : ''}
                    </td>
                    <td>${obs.parentKnowledge || '‚Äî'}</td>
                    <td>${obs.notes || '‚Äî'}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        ` : ''}

        ${entry.demeanor.length > 0 ? `
          <div class="section">
            <div class="section-header">üòä Overall Child Demeanor</div>
            <div class="demeanor-chips">
              ${entry.demeanor.map(d => `<span class="demeanor-chip">${d}</span>`).join('')}
            </div>
          </div>
        ` : ''}

        ${entry.photos.length > 0 ? `
          <div class="section">
            <div class="section-header">üì∑ Photographic Documentation (${entry.photos.length})</div>
            <p style="font-size: 9pt; color: #64748b; margin-bottom: 10px;">
              <strong>Original Files:</strong> Stored in ${entry.storageLocation}
            </p>
            <div class="photo-grid">
              ${entry.photos.map((photo, pIdx) => `
                <div class="photo-container">
                  <img src="${photo.data}" alt="Documentation Photo ${pIdx + 1}">
                  <div class="photo-caption">
                    <strong>Photo ${pIdx + 1}</strong> - ${photo.name}<br>
                    Timestamp: ${new Date(photo.timestamp).toLocaleString()}
                    ${photo.annotated ? '<br><span style="color: #2563eb;">‚úì Annotated</span>' : ''}
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        ` : ''}

        ${entry.additionalObservations ? `
          <div class="section">
            <div class="section-header">üìÑ Additional Observations</div>
            <div class="additional-obs">
              <p>${entry.additionalObservations}</p>
            </div>
          </div>
        ` : ''}

        <div class="document-footer">
          <div class="footer-item"><strong>Documented by:</strong> ${entry.loggedBy}</div>
          <div class="footer-item"><strong>Date Logged:</strong> ${entry.dateLogged}</div>
          <div class="footer-item"><strong>Document Generated:</strong> ${new Date().toLocaleString()}</div>
          <div class="footer-item"><strong>System Timestamp:</strong> ${entry.createdTimestamp}</div>
          <div class="footer-item" style="margin-top: 10px; font-style: italic;">
            Original records maintained by Tamas Kiss for legal chain of custody.
          </div>
          
          <div class="signature-line">
            Signature: ___________________________
          </div>
        </div>

        ${idx < entriesToExport.length - 1 ? '<div class="page-break"></div>' : ''}
      `;
    });

    html += `
      </body>
      </html>
    `;

    return html;
  };

  const filteredEntries = entries.filter(entry => {
    const matchesSearch = searchTerm === '' || 
      entry.child.toLowerCase().includes(searchTerm.toLowerCase()) ||
      entry.quickNotes?.toLowerCase().includes(searchTerm.toLowerCase()) ||
      entry.observations.some(obs => 
        obs.bodyArea?.toLowerCase().includes(searchTerm.toLowerCase()) ||
        obs.observation?.toLowerCase().includes(searchTerm.toLowerCase())
      );
    const matchesChild = filterChild === 'all' || entry.child === filterChild;
    return matchesSearch && matchesChild;
  });

  // Comparison view logic
  const getBeforeAfterPairs = () => {
    const pairs = [];
    const sorted = [...entries].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
    
    for (let i = 0; i < sorted.length - 1; i++) {
      const current = sorted[i];
      const next = sorted[i + 1];
      
      // Check if they form a before/after pair
      if (current.context === 'Before exchange' && next.context === 'After exchange' &&
          current.child === next.child) {
        pairs.push({ before: current, after: next });
      }
    }
    
    return pairs;
  };

  const bgClass = darkMode ? 'bg-gray-900' : 'bg-gray-50';
  const cardBgClass = darkMode ? 'bg-gray-800' : 'bg-white';
  const textClass = darkMode ? 'text-gray-100' : 'text-gray-800';
  const textSecondaryClass = darkMode ? 'text-gray-300' : 'text-gray-700';
  const borderClass = darkMode ? 'border-gray-700' : 'border-gray-300';
  const inputBgClass = darkMode ? 'bg-gray-700 text-white' : 'bg-white';
  const sectionBgClass = darkMode ? 'bg-gray-700' : 'bg-gray-50';

  // Comparison View
  if (showComparison) {
    const pairs = getBeforeAfterPairs();
    
    return (
      <div className={`min-h-screen ${bgClass} p-6`}>
        <div className="max-w-7xl mx-auto">
          <div className={`${cardBgClass} rounded-lg shadow-lg p-6 mb-6`}>
            <div className="flex justify-between items-center mb-6">
              <h1 className={`text-3xl font-bold ${textClass}`}>Before/After Comparison View</h1>
              <div className="flex gap-2">
                <button
                  onClick={toggleDarkMode}
                  className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}
                >
                  {darkMode ? <Sun size={20} /> : <Moon size={20} />}
                </button>
                <button
                  onClick={() => setShowComparison(false)}
                  className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
                >
                  Back to List
                </button>
              </div>
            </div>

            {pairs.length === 0 ? (
              <div className={`text-center py-12 ${textSecondaryClass}`}>
                <ArrowLeftRight size={48} className="mx-auto mb-4 text-gray-400" />
                <p className="text-lg">No before/after pairs found yet.</p>
                <p className="text-sm mt-2">Create entries with "Before exchange" and "After exchange" context to see comparisons.</p>
              </div>
            ) : (
              <div className="space-y-8">
                {pairs.map((pair, idx) => (
                  <div key={idx} className={`border ${borderClass} rounded-lg p-6`}>
                    <h3 className={`text-xl font-bold ${textClass} mb-4`}>
                      {pair.before.child} - {new Date(pair.before.date).toLocaleDateString()} Exchange
                    </h3>
                    
                    <div className="grid grid-cols-2 gap-6">
                      {/* Before */}
                      <div className="border-r pr-6">
                        <h4 className="font-semibold text-green-600 mb-3">BEFORE Exchange</h4>
                        <p className="text-sm mb-2"><strong>Time:</strong> {new Date(pair.before.timestamp).toLocaleTimeString()}</p>
                        {pair.before.quickNotes && (
                          <p className="text-sm mb-2 italic bg-yellow-50 p-2 rounded">{pair.before.quickNotes}</p>
                        )}
                        <p className="text-sm mb-2"><strong>Demeanor:</strong> {pair.before.demeanor.join(', ') || 'None recorded'}</p>
                        <p className="text-sm mb-2"><strong>Observations:</strong> {pair.before.observations.length}</p>
                        {pair.before.observations.map((obs, oIdx) => (
                          <div key={oIdx} className="text-xs bg-gray-100 p-2 rounded mb-2">
                            <strong>{obs.bodyArea}:</strong> {obs.observation}
                          </div>
                        ))}
                        {pair.before.photos.length > 0 && (
                          <div className="mt-2">
                            <strong className="text-sm">Photos:</strong>
                            <div className="grid grid-cols-2 gap-2 mt-1">
                              {pair.before.photos.slice(0, 4).map((photo, pIdx) => (
                                <img key={pIdx} src={photo.data} alt="" className="w-full h-24 object-cover rounded" />
                              ))}
                            </div>
                          </div>
                        )}
                      </div>

                      {/* After */}
                      <div className="pl-6">
                        <h4 className="font-semibold text-red-600 mb-3">AFTER Exchange</h4>
                        <p className="text-sm mb-2"><strong>Time:</strong> {new Date(pair.after.timestamp).toLocaleTimeString()}</p>
                        {pair.after.quickNotes && (
                          <p className="text-sm mb-2 italic bg-yellow-50 p-2 rounded">{pair.after.quickNotes}</p>
                        )}
                        <p className="text-sm mb-2"><strong>Demeanor:</strong> {pair.after.demeanor.join(', ') || 'None recorded'}</p>
                        <p className="text-sm mb-2"><strong>Observations:</strong> {pair.after.observations.length}</p>
                        {pair.after.observations.map((obs, oIdx) => (
                          <div key={oIdx} className="text-xs bg-gray-100 p-2 rounded mb-2">
                            <strong>{obs.bodyArea}:</strong> {obs.observation}
                          </div>
                        ))}
                        {pair.after.photos.length > 0 && (
                          <div className="mt-2">
                            <strong className="text-sm">Photos:</strong>
                            <div className="grid grid-cols-2 gap-2 mt-1">
                              {pair.after.photos.slice(0, 4).map((photo, pIdx) => (
                                <img key={pIdx} src={photo.data} alt="" className="w-full h-24 object-cover rounded" />
                              ))}
                            </div>
                          </div>
                        )}
                      </div>
                    </div>

                    {/* Export comparison */}
                    <div className="mt-4 pt-4 border-t">
                      <button
                        onClick={() => generatePDF([pair.before, pair.after])}
                        className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm"
                      >
                        <Download size={16} className="inline mr-2" />
                        Export This Comparison
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
    );
  }

  // List View
  if (view === 'list') {
    return (
      <div className={`min-h-screen ${bgClass} p-3 sm:p-6`}>
        <div className="max-w-6xl mx-auto">
          <div className={`${cardBgClass} rounded-lg shadow-lg p-4 sm:p-6 mb-6`}>
            {/* Mobile-optimized header */}
            <div className="mb-4 sm:mb-6">
              <h1 className={`text-xl sm:text-3xl font-bold ${textClass} mb-3`}>Child Documentation</h1>
              <div className="flex flex-wrap gap-2">
                <button
                  onClick={toggleDarkMode}
                  className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}
                  title="Toggle dark mode"
                >
                  {darkMode ? <Sun size={20} /> : <Moon size={20} />}
                </button>
                <button
                  onClick={() => setShowComparison(true)}
                  className="bg-purple-600 text-white px-3 py-2 rounded-lg hover:bg-purple-700 flex items-center gap-2 text-sm flex-1 sm:flex-initial justify-center"
                >
                  <ArrowLeftRight size={16} />
                  <span>Compare</span>
                </button>
                <button
                  onClick={createNewEntry}
                  className="bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2 text-sm flex-1 sm:flex-initial justify-center"
                >
                  <FileText size={16} />
                  <span>New Entry</span>
                </button>
              </div>
            </div>

            <div className="flex flex-col sm:flex-row gap-2 sm:gap-4 mb-4 sm:mb-6">
              <div className="flex-1 relative">
                <Search className={`absolute left-3 top-2.5 ${darkMode ? 'text-gray-400' : 'text-gray-400'}`} size={18} />
                <input
                  type="text"
                  placeholder="Search..."
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className={`w-full pl-10 pr-3 py-2 border ${borderClass} ${inputBgClass} rounded-lg focus:ring-2 focus:ring-blue-500 text-sm`}
                />
              </div>
              <div className="flex items-center gap-2">
                <Filter size={18} className={textSecondaryClass} />
                <select
                  value={filterChild}
                  onChange={(e) => setFilterChild(e.target.value)}
                  className={`flex-1 sm:w-auto px-3 py-2 border ${borderClass} ${inputBgClass} rounded-lg focus:ring-2 focus:ring-blue-500 text-sm`}
                >
                  <option value="all">All Children</option>
                  <option value="Benjamin">Benjamin</option>
                  <option value="Vincent">Vincent</option>
                </select>
              </div>
            </div>

            {downloadMessage && (
              <div className="mb-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                <p className="text-green-800 text-sm">{downloadMessage}</p>
              </div>
            )}

            {selectedEntries.size > 0 && (
              <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                <div className="flex justify-between items-center">
                  <span className="text-blue-800 font-medium">
                    {selectedEntries.size} {selectedEntries.size === 1 ? 'entry' : 'entries'} selected
                  </span>
                  <div className="flex gap-2">
                    <button
                      onClick={() => {
                        const selected = entries.filter(e => selectedEntries.has(e.id));
                        console.log('Selected entries:', selected.length);
                        if (selected.length === 0) {
                          console.error('No entries selected. Please check boxes next to entries.');
                          return;
                        }
                        generatePDF(selected);
                      }}
                      className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 flex items-center gap-2"
                    >
                      <Download size={18} />
                      Export Selected to PDF
                    </button>
                    <button
                      onClick={() => setSelectedEntries(new Set())}
                      className="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600"
                    >
                      Clear Selection
                    </button>
                  </div>
                </div>
              </div>
            )}

            {filteredEntries.length === 0 ? (
              <div className={`text-center py-12 ${textSecondaryClass}`}>
                <FileText size={48} className="mx-auto mb-4 text-gray-300" />
                <p className="text-lg">No entries yet. Create your first documentation entry.</p>
              </div>
            ) : (
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className={`${sectionBgClass} border-b-2 ${borderClass}`}>
                    <tr>
                      <th className="px-4 py-3 text-left">
                        <input
                          type="checkbox"
                          checked={selectedEntries.size === filteredEntries.length && filteredEntries.length > 0}
                          onChange={(e) => {
                            if (e.target.checked) {
                              setSelectedEntries(new Set(filteredEntries.map(e => e.id)));
                            } else {
                              setSelectedEntries(new Set());
                            }
                          }}
                          className="w-4 h-4"
                        />
                      </th>
                      <th className={`px-4 py-3 text-left text-sm font-semibold ${textSecondaryClass}`}>Entry #</th>
                      <th className={`px-4 py-3 text-left text-sm font-semibold ${textSecondaryClass}`}>Child</th>
                      <th className={`px-4 py-3 text-left text-sm font-semibold ${textSecondaryClass}`}>Date/Time</th>
                      <th className={`px-4 py-3 text-left text-sm font-semibold ${textSecondaryClass}`}>Context</th>
                      <th className={`px-4 py-3 text-left text-sm font-semibold ${textSecondaryClass}`}>Quick Notes</th>
                      <th className={`px-4 py-3 text-left text-sm font-semibold ${textSecondaryClass}`}>Observations</th>
                      <th className={`px-4 py-3 text-left text-sm font-semibold ${textSecondaryClass}`}>Photos</th>
                      <th className={`px-4 py-3 text-left text-sm font-semibold ${textSecondaryClass}`}>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {filteredEntries.map(entry => (
                      <tr key={entry.id} className={`border-b ${borderClass} hover:${sectionBgClass}`}>
                        <td className="px-4 py-3">
                          <input
                            type="checkbox"
                            checked={selectedEntries.has(entry.id)}
                            onChange={() => toggleSelectEntry(entry.id)}
                            className="w-4 h-4"
                          />
                        </td>
                        <td className={`px-4 py-3 text-sm font-medium ${textClass}`}>{entry.entryNumber}</td>
                        <td className={`px-4 py-3 text-sm ${textSecondaryClass}`}>{entry.child}</td>
                        <td className={`px-4 py-3 text-sm ${textSecondaryClass}`}>
                          {entry.date}<br/>
                          <span className="text-xs text-gray-500">{new Date(entry.timestamp).toLocaleTimeString()}</span>
                        </td>
                        <td className={`px-4 py-3 text-sm ${textSecondaryClass}`}>
                          {entry.context}
                          {entry.contextOther && <><br/><span className="text-xs text-gray-500">{entry.contextOther}</span></>}
                        </td>
                        <td className={`px-4 py-3 text-sm ${textSecondaryClass}`}>
                          {entry.quickNotes ? (
                            <span className="italic text-xs">{entry.quickNotes.substring(0, 50)}{entry.quickNotes.length > 50 ? '...' : ''}</span>
                          ) : (
                            <span className="text-gray-400">‚Äî</span>
                          )}
                        </td>
                        <td className={`px-4 py-3 text-sm ${textSecondaryClass}`}>{entry.observations.length}</td>
                        <td className={`px-4 py-3 text-sm ${textSecondaryClass}`}>{entry.photos.length}</td>
                        <td className="px-4 py-3">
                          <div className="flex gap-2">
                            <button
                              onClick={() => editEntry(entry)}
                              className="text-blue-600 hover:text-blue-800"
                              title="Edit"
                            >
                              <Eye size={18} />
                            </button>
                            <button
                              onClick={() => {
                                console.log('Exporting entry:', entry);
                                generatePDF([entry]);
                              }}
                              className="text-green-600 hover:text-green-800"
                              title="Export to PDF"
                            >
                              <Download size={18} />
                            </button>
                            <button
                              onClick={() => deleteEntry(entry.id)}
                              className="text-red-600 hover:text-red-800"
                              title="Delete"
                            >
                              <Trash2 size={18} />
                            </button>
                          </div>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        </div>
      </div>
    );
  }

  // Form View - continues in next message due to length
  if (view === 'form' && currentEntry) {
    return (
      <div className={`min-h-screen ${bgClass} p-6`}>
        <div className="max-w-4xl mx-auto">
          <div className={`${cardBgClass} rounded-lg shadow-lg p-8`}>
            <div className="flex justify-between items-center mb-6">
              <h1 className={`text-2xl font-bold ${textClass}`}>
                {currentEntry.id && entries.find(e => e.id === currentEntry.id) ? 'Edit Entry' : 'New Entry'}
              </h1>
              <div className="flex gap-2">
                <button
                  onClick={toggleDarkMode}
                  className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}
                >
                  {darkMode ? <Sun size={20} /> : <Moon size={20} />}
                </button>
                <button
                  onClick={() => {
                    setCurrentEntry(null);
                    setView('list');
                  }}
                  className={`${textSecondaryClass} hover:${textClass}`}
                >
                  Cancel
                </button>
              </div>
            </div>

            {/* Quick Notes Section */}
            <div className={`mb-6 p-4 ${sectionBgClass} rounded-lg border-l-4 border-yellow-500`}>
              <div className="flex justify-between items-center mb-2">
                <h2 className={`text-lg font-semibold ${textSecondaryClass}`}>Quick Notes</h2>
                <button
                  onClick={() => {
                    if (isRecording && recordingField?.type === 'quickNotes') {
                      stopRecording();
                    } else {
                      startRecording('quickNotes');
                    }
                  }}
                  className={`p-2 rounded ${isRecording && recordingField?.type === 'quickNotes' ? 'bg-red-500 text-white' : 'bg-gray-200 text-gray-700'}`}
                  title="Voice to text"
                >
                  {isRecording && recordingField?.type === 'quickNotes' ? <MicOff size={16} /> : <Mic size={16} />}
                </button>
              </div>
              <textarea
                value={currentEntry.quickNotes}
                onChange={(e) => setCurrentEntry({ ...currentEntry, quickNotes: e.target.value })}
                placeholder="e.g., 'Returned 30 minutes late from exchange', 'Had meltdown when dropped off', 'Was at grandma's house for pickup'"
                className={`w-full px-3 py-2 border ${borderClass} ${inputBgClass} rounded-lg focus:ring-2 focus:ring-yellow-500`}
                rows="2"
              />
              <p className="text-xs text-gray-500 mt-1">
                Context notes for this documentation session
              </p>
            </div>

            {/* Basic Information - REST OF FORM CONTINUES... */}
            <div className={`mb-6 p-4 ${sectionBgClass} rounded-lg`}>
              <h2 className={`text-lg font-semibold mb-4 ${textSecondaryClass}`}>Basic Information</h2>
              
              <div className="grid grid-cols-2 gap-4 mb-4">
                <div>
                  <label className={`block text-sm font-medium ${textSecondaryClass} mb-2`}>Child *</label>
                  <select
                    value={currentEntry.child}
                    onChange={(e) => {
                      const child = e.target.value;
                      const age = child && childDOBs[child] ? calculateAge(childDOBs[child], currentEntry.date) : '';
                      setCurrentEntry({ ...currentEntry, child, childAge: age });
                    }}
                    className={`w-full px-3 py-2 border ${borderClass} ${inputBgClass} rounded-lg focus:ring-2 focus:ring-blue-500`}
                    required
                  >
                    <option value="">Select child</option>
                    <option value="Benjamin">Benjamin</option>
                    <option value="Vincent">Vincent</option>
                  </select>
                </div>

                <div>
                  <label className={`block text-sm font-medium ${textSecondaryClass} mb-2`}>Child Age (auto-calculated)</label>
                  <input
                    type="text"
                    value={currentEntry.childAge}
                    readOnly
                    className={`w-full px-3 py-2 border ${borderClass} bg-gray-200 ${darkMode ? 'text-gray-500' : 'text-gray-600'} rounded-lg`}
                    placeholder="Select child to calculate"
                  />
                </div>
              </div>

              <div className="mb-4">
                <label className={`block text-sm font-medium ${textSecondaryClass} mb-2`}>Observation Date *</label>
                <input
                  type="date"
                  value={currentEntry.date}
                  onChange={(e) => {
                    const date = e.target.value;
                    const age = currentEntry.child && childDOBs[currentEntry.child] ? 
                      calculateAge(childDOBs[currentEntry.child], date) : '';
                    setCurrentEntry({ ...currentEntry, date, childAge: age });
                  }}
                  className={`w-full px-3 py-2 border ${borderClass} ${inputBgClass} rounded-lg focus:ring-2 focus:ring-blue-500`}
                  required
                />
                <p className="text-xs text-gray-500 mt-1">
                  <strong>Did this happen today?</strong> If not, change the date above to when you first observed these marks.
                </p>
              </div>

              <div className="mb-4">
                <label className={`block text-sm font-medium ${textSecondaryClass} mb-2`}>Location</label>
                <input
                  type="text"
                  value={currentEntry.location}
                  onChange={(e) => setCurrentEntry({ ...currentEntry, location: e.target.value })}
                  placeholder="Default: Home (Springfield, MO)"
                  className={`w-full px-3 py-2 border ${borderClass} ${inputBgClass} rounded-lg focus:ring-2 focus:ring-blue-500`}
                />
                <p className="text-xs text-gray-500 mt-1">Override if documenting at different location</p>
              </div>

              <div>
                <label className={`block text-sm font-medium ${textSecondaryClass} mb-2`}>Context *</label>
                <div className="space-y-2">
                  {['Before exchange', 'After exchange', 'Other'].map(ctx => (
                    <label key={ctx} className="flex items-center">
                      <input
                        type="radio"
                        checked={currentEntry.context === ctx}
                        onChange={() => setCurrentEntry({ ...currentEntry, context: ctx })}
                        className="mr-2"
                      />
                      <span className={textSecondaryClass}>{ctx}</span>
                    </label>
                  ))}
                </div>
                {currentEntry.context === 'Other' && (
                  <input
                    type="text"
                    value={currentEntry.contextOther}
                    onChange={(e) => setCurrentEntry({ ...currentEntry, contextOther: e.target.value })}
                    placeholder="Specify context"
                    className={`mt-2 w-full px-3 py-2 border ${borderClass} ${inputBgClass} rounded-lg focus:ring-2 focus:ring-blue-500`}
                  />
                )}
              </div>

              <div className="mt-4 pt-4 border-t border-gray-300">
                <label className={`block text-sm font-medium ${textSecondaryClass} mb-2`}>
                  Others Present (Witnesses) - Optional
                </label>
                <input
                  type="text"
                  value={currentEntry.witnessPresent}
                  onChange={(e) => setCurrentEntry({ ...currentEntry, witnessPresent: e.target.value })}
                  placeholder="Names of witnesses present (if any)"
                  className={`w-full px-3 py-2 border ${borderClass} ${inputBgClass} rounded-lg focus:ring-2 focus:ring-blue-500`}
                />
                <p className="text-xs text-gray-500 mt-1">
                  Third-party corroboration strengthens documentation if needed in court
                </p>
              </div>
            </div>

            {/* Observations - simplified for now, will add photo annotation in next iteration */}
            <div className={`mb-6 p-4 bg-blue-50 ${darkMode ? 'bg-blue-900' : ''} rounded-lg`}>
              <div className="flex justify-between items-center mb-4">
                <h2 className={`text-lg font-semibold ${textSecondaryClass}`}>Observed Areas</h2>
                <button
                  onClick={addObservation}
                  className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm"
                >
                  + Add Observation
                </button>
              </div>

              {currentEntry.observations.map((obs, idx) => (
                <div key={idx} className={`mb-4 p-4 ${cardBgClass} rounded-lg border ${borderClass}`}>
                  <div className="flex justify-between items-start mb-3">
                    <span className={`font-medium ${textSecondaryClass}`}>Observation {idx + 1}</span>
                    <button
                      onClick={() => removeObservation(idx)}
                      className="text-red-600 hover:text-red-800"
                    >
                      <Trash2 size={16} />
                    </button>
                  </div>

                  <div className="grid grid-cols-2 gap-3 mb-3">
                    <div className="col-span-2">
                      <label className="block text-xs font-medium text-gray-600 mb-1">Body Area</label>
                      <input
                        type="text"
                        value={obs.bodyArea}
                        onChange={(e) => updateObservation(idx, 'bodyArea', e.target.value)}
                        placeholder="e.g., Left knee"
                        className={`w-full px-2 py-1 text-sm border ${borderClass} ${inputBgClass} rounded focus:ring-2 focus:ring-blue-500`}
                      />
                    </div>
                  </div>

                  <div className="mt-3">
                    <div className="flex justify-between items-center mb-1">
                      <label className="block text-xs font-medium text-gray-600">Observation (neutral description)</label>
                      <button
                        onClick={() => {
                          if (isRecording && recordingField?.type === 'observation' && recordingField.index === idx) {
                            stopRecording();
                          } else {
                            startRecording('observation', idx);
                          }
                        }}
                        className={`p-1 rounded text-xs ${isRecording && recordingField?.type === 'observation' && recordingField.index === idx ? 'bg-red-500 text-white' : 'bg-gray-200 text-gray-700'}`}
                        title="Voice to text"
                      >
                        {isRecording && recordingField?.type === 'observation' && recordingField.index === idx ? <MicOff size={14} /> : <Mic size={14} />}
                      </button>
                    </div>
                    <textarea
                      value={obs.observation}
                      onChange={(e) => updateObservation(idx, 'observation', e.target.value)}
                      placeholder={`Examples:
‚Ä¢ Small bruise, approx. 1 inch diameter, purple/yellow coloring
‚Ä¢ Red mark on forearm, approx. 2 inches long, slightly raised
‚Ä¢ No visible marks or injuries observed`}
                      className={`w-full px-2 py-1 text-sm border ${borderClass} ${inputBgClass} rounded focus:ring-2 focus:ring-blue-500`}
                      rows="3"
                    />
                  </div>

                  <div className="mt-3">
                    <label className="block text-xs font-medium text-gray-600 mb-1">Parent Knowledge</label>
                    <div className="flex gap-4">
                      <label className="flex items-center text-xs">
                        <input
                          type="radio"
                          checked={obs.parentKnowledge === 'Known'}
                          onChange={() => updateObservation(idx, 'parentKnowledge', 'Known')}
                          className="mr-1"
                        />
                        Known
                      </label>
                      <label className="flex items-center text-xs">
                        <input
                          type="radio"
                          checked={obs.parentKnowledge === 'Unknown'}
                          onChange={() => updateObservation(idx, 'parentKnowledge', 'Unknown')}
                          className="mr-1"
                        />
                        Unknown
                      </label>
                    </div>
                  </div>

                  <div className="mt-3 p-3 bg-yellow-50 rounded border border-yellow-200">
                    <label className="block text-xs font-medium text-gray-700 mb-2">Child Awareness</label>
                    <div className="space-y-2 mb-2">
                      <label className="flex items-center text-sm">
                        <input
                          type="radio"
                          checked={obs.childAware === 'aware'}
                          onChange={() => updateObservation(idx, 'childAware', 'aware')}
                          className="mr-2"
                        />
                        Child aware of observation
                      </label>
                      <label className="flex items-center text-sm">
                        <input
                          type="radio"
                          checked={obs.childAware === 'unaware'}
                          onChange={() => updateObservation(idx, 'childAware', 'unaware')}
                          className="mr-2"
                        />
                        Child unaware
                      </label>
                    </div>

                    {obs.childAware === 'aware' && (
                      <div className="mt-2">
                        <div className="flex justify-between items-center mb-1">
                          <label className="block text-xs font-medium text-gray-600">
                            Child&apos;s Explanation (exact words if possible)
                          </label>
                          <button
                            onClick={() => {
                              if (isRecording && recordingField?.type === 'childExplanation' && recordingField.index === idx) {
                                stopRecording();
                              } else {
                                startRecording('childExplanation', idx);
                              }
                            }}
                            className={`p-1 rounded text-xs ${isRecording && recordingField?.type === 'childExplanation' && recordingField.index === idx ? 'bg-red-500 text-white' : 'bg-gray-200 text-gray-700'}`}
                            title="Voice to text"
                          >
                            {isRecording && recordingField?.type === 'childExplanation' && recordingField.index === idx ? <MicOff size={14} /> : <Mic size={14} />}
                          </button>
                        </div>
                        <textarea
                          value={obs.childExplanation}
                          onChange={(e) => updateObservation(idx, 'childExplanation', e.target.value)}
                          placeholder="e.g., &quot;I fell on the playground&quot; or &quot;I don't remember&quot;"
                          className="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                          rows="2"
                        />
                      </div>
                    )}

                    {(obs.childAware === 'aware' || obs.childAware === 'unaware') && (
                      <div className="mt-2">
                        <label className="block text-xs font-medium text-gray-600 mb-1">
                          Child&apos;s Demeanor When Discussing
                        </label>
                        <div className="space-y-1">
                          {['Matter-of-fact', 'Hesitant', 'Upset', 'Changed subject'].map(d => (
                            <label key={d} className="flex items-center text-xs">
                              <input
                                type="checkbox"
                                checked={obs.childDemeanorDiscussing?.includes(d) || false}
                                onChange={(e) => {
                                  const current = obs.childDemeanorDiscussing || [];
                                  if (e.target.checked) {
                                    updateObservation(idx, 'childDemeanorDiscussing', [...current, d]);
                                  } else {
                                    updateObservation(idx, 'childDemeanorDiscussing', current.filter(item => item !== d));
                                  }
                                }}
                                className="mr-2"
                              />
                              <span>{d}</span>
                            </label>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>

                  <div className="mt-3">
                    <label className="block text-xs font-medium text-gray-600 mb-1">Additional Notes</label>
                    <input
                      type="text"
                      value={obs.notes}
                      onChange={(e) => updateObservation(idx, 'notes', e.target.value)}
                      placeholder="Any other relevant information"
                      className={`w-full px-2 py-1 text-sm border ${borderClass} ${inputBgClass} rounded focus:ring-2 focus:ring-blue-500`}
                    />
                  </div>
                </div>
              ))}

              {currentEntry.observations.length === 0 && (
                <p className="text-sm text-gray-500 text-center py-4">
                  No observations added yet. Click &quot;Add Observation&quot; to begin.
                </p>
              )}
            </div>

            {/* Overall Child Demeanor */}
            <div className={`mb-6 p-4 ${sectionBgClass} rounded-lg`}>
              <h2 className={`text-lg font-semibold mb-4 ${textSecondaryClass}`}>Overall Child Demeanor</h2>
              
              <div className="space-y-2">
                {['Happy/Playful', 'Calm/Neutral', 'Tired', 'Withdrawn', 'Upset/Distressed'].map(d => (
                  <label key={d} className="flex items-center">
                    <input
                      type="checkbox"
                      checked={currentEntry.demeanor.includes(d)}
                      onChange={(e) => {
                        if (e.target.checked) {
                          setCurrentEntry({ ...currentEntry, demeanor: [...currentEntry.demeanor, d] });
                        } else {
                          setCurrentEntry({ ...currentEntry, demeanor: currentEntry.demeanor.filter(item => item !== d) });
                        }
                      }}
                      className="mr-2"
                    />
                    <span className={textSecondaryClass}>{d}</span>
                  </label>
                ))}
              </div>
              <p className="text-xs text-gray-500 mt-2">
                Document overall emotional state - helpful for establishing patterns
              </p>
            </div>

            {/* Attach Media */}
            <div className={`mb-6 p-4 ${darkMode ? 'bg-purple-900' : 'bg-purple-50'} rounded-lg`}>
              <h2 className={`text-lg font-semibold mb-4 ${textSecondaryClass}`}>Attach Media</h2>
              
              <div>
                <input
                  type="file"
                  accept="image/*,video/*"
                  multiple
                  onChange={handlePhotoUpload}
                  className={`w-full px-3 py-2 border ${borderClass} ${inputBgClass} rounded-lg focus:ring-2 focus:ring-blue-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100`}
                />
                
                {currentEntry.photos.length > 0 && (
                  <div className="mt-4 grid grid-cols-3 gap-4">
                    {currentEntry.photos.map((photo, idx) => (
                      <div key={idx} className={`relative border ${borderClass} rounded-lg p-2`}>
                        <img src={photo.data} alt={`Photo ${idx + 1}`} className="w-full h-32 object-cover rounded" />
                        {photo.annotated && (
                          <span className="absolute top-2 left-2 bg-blue-500 text-white text-xs px-2 py-1 rounded">
                            Annotated
                          </span>
                        )}
                        <div className="absolute top-1 right-1 flex gap-1">
                          <button
                            onClick={() => openAnnotationModal(idx)}
                            className="bg-blue-600 text-white p-1 rounded hover:bg-blue-700"
                            title="Annotate photo"
                          >
                            ‚úèÔ∏è
                          </button>
                          {photo.annotated && (
                            <button
                              onClick={() => undoAnnotation(idx)}
                              className="bg-yellow-600 text-white p-1 rounded hover:bg-yellow-700 text-xs"
                              title="Undo annotations"
                            >
                              ‚Ü∂
                            </button>
                          )}
                          <button
                            onClick={() => removePhoto(idx)}
                            className="bg-red-600 text-white p-1 rounded hover:bg-red-700"
                            title="Delete"
                          >
                            <Trash2 size={14} />
                          </button>
                        </div>
                        <p className="text-xs text-gray-600 mt-1 truncate">{photo.name}</p>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>

            {/* Media & Document Storage */}
            <div className={`mb-6 p-4 ${sectionBgClass} rounded-lg`}>
              <div className="flex items-center gap-2 mb-2">
                <h2 className={`text-sm font-semibold ${textSecondaryClass}`}>Media & Document Storage</h2>
              </div>
              <p className={`text-sm ${textSecondaryClass}`}>
                Original media files and all other documentation is stored in <span className={`font-medium ${textClass}`}>iCloud Drive</span> for legal chain of custody.
              </p>
            </div>

            {/* Additional Observations */}
            <div className={`mb-6 p-4 ${sectionBgClass} rounded-lg`}>
              <div className="flex justify-between items-center mb-4">
                <h2 className={`text-lg font-semibold ${textSecondaryClass}`}>Additional Observations</h2>
                <button
                  onClick={() => {
                    if (isRecording && recordingField?.type === 'additionalObservations') {
                      stopRecording();
                    } else {
                      startRecording('additionalObservations');
                    }
                  }}
                  className={`p-2 rounded ${isRecording && recordingField?.type === 'additionalObservations' ? 'bg-red-500 text-white' : 'bg-gray-200 text-gray-700'}`}
                  title="Voice to text"
                >
                  {isRecording && recordingField?.type === 'additionalObservations' ? <MicOff size={16} /> : <Mic size={16} />}
                </button>
              </div>
              <textarea
                value={currentEntry.additionalObservations}
                onChange={(e) => setCurrentEntry({ ...currentEntry, additionalObservations: e.target.value })}
                placeholder="Optional factual notes"
                className={`w-full px-3 py-2 border ${borderClass} ${inputBgClass} rounded-lg focus:ring-2 focus:ring-blue-500`}
                rows="4"
              />
            </div>

            {/* Logged By */}
            <div className={`mb-6 p-4 ${sectionBgClass} rounded-lg`}>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className={`block text-sm font-medium ${textSecondaryClass} mb-2`}>Logged By</label>
                  <input
                    type="text"
                    value={currentEntry.loggedBy}
                    readOnly
                    className={`w-full px-3 py-2 border ${borderClass} bg-gray-200 ${darkMode ? 'text-gray-500' : 'text-gray-600'} rounded-lg`}
                  />
                </div>

                <div>
                  <label className={`block text-sm font-medium ${textSecondaryClass} mb-2`}>Date Logged (Auto)</label>
                  <input
                    type="text"
                    value={new Date(currentEntry.dateLogged).toLocaleDateString()}
                    readOnly
                    className={`w-full px-3 py-2 border ${borderClass} bg-gray-200 ${darkMode ? 'text-gray-500' : 'text-gray-600'} rounded-lg`}
                  />
                </div>
              </div>
              <p className="text-xs text-gray-500 mt-2">
                Date Logged = when you entered this documentation. Date (above) = when observation occurred.
              </p>
            </div>

            {/* Save Button */}
            <div className="flex justify-end gap-4">
              <button
                onClick={() => {
                  setCurrentEntry(null);
                  setView('list');
                }}
                className={`px-6 py-2 border ${borderClass} rounded-lg hover:${sectionBgClass}`}
              >
                Cancel
              </button>
              <button
                onClick={saveEntry}
                className="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700"
                disabled={!currentEntry.child || !currentEntry.date || !currentEntry.context}
              >
                Save Entry
              </button>
            </div>

            {/* Photo Annotation Modal */}
            {annotatingPhoto !== null && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className={`${cardBgClass} rounded-lg shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-auto`}>
                  <div className="p-6">
                    <div className="flex justify-between items-center mb-4">
                      <h2 className={`text-xl font-bold ${textClass}`}>Annotate Photo</h2>
                      <button
                        onClick={cancelAnnotation}
                        className={`${textSecondaryClass} hover:${textClass}`}
                      >
                        ‚úï
                      </button>
                    </div>

                    <div className="mb-4">
                      <p className={`text-sm ${textSecondaryClass} mb-2`}>
                        Draw arrows or circles to highlight areas of concern
                      </p>
                      
                      {/* Tool Selection */}
                      <div className="flex gap-2 mb-3 flex-wrap items-center">
                        <button
                          onClick={() => setDrawTool('arrow')}
                          className={`px-3 py-2 rounded ${drawTool === 'arrow' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}`}
                        >
                          ‚û°Ô∏è Arrow
                        </button>
                        <button
                          onClick={() => setDrawTool('circle')}
                          className={`px-3 py-2 rounded ${drawTool === 'circle' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}`}
                        >
                          ‚≠ï Circle
                        </button>
                        <button
                          onClick={() => setDrawTool('line')}
                          className={`px-3 py-2 rounded ${drawTool === 'line' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}`}
                        >
                          üìè Line
                        </button>
                        
                        {/* Color Picker */}
                        <div className="flex items-center gap-2 ml-4">
                          <label className="text-sm">Color:</label>
                          <input
                            type="color"
                            value={drawColor}
                            onChange={(e) => setDrawColor(e.target.value)}
                            className="w-10 h-10 rounded cursor-pointer"
                          />
                        </div>

                        {/* Thickness Slider */}
                        <div className="flex items-center gap-2 ml-4">
                          <label className="text-sm">Thickness:</label>
                          <input
                            type="range"
                            min="1"
                            max="10"
                            value={drawThickness}
                            onChange={(e) => setDrawThickness(parseInt(e.target.value))}
                            className="w-24"
                          />
                          <span className="text-sm w-6">{drawThickness}</span>
                        </div>

                        {/* Clear All Button */}
                        <button
                          onClick={() => setAnnotations([])}
                          className="ml-auto px-3 py-2 rounded bg-red-600 text-white hover:bg-red-700"
                        >
                          üóëÔ∏è Clear All
                        </button>
                      </div>

                      {/* Canvas for annotation */}
                      <AnnotationCanvas
                        photo={currentEntry.photos[annotatingPhoto.photoIndex]}
                        canvasRef={canvasRef}
                        drawTool={drawTool}
                        drawColor={drawColor}
                        drawThickness={drawThickness}
                        annotations={annotations}
                        setAnnotations={setAnnotations}
                      />
                    </div>

                    <div className="flex justify-end gap-3">
                      <button
                        onClick={cancelAnnotation}
                        className={`px-4 py-2 border ${borderClass} rounded hover:${sectionBgClass}`}
                      >
                        Cancel
                      </button>
                      <button
                        onClick={saveAnnotatedPhoto}
                        className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                      >
                        Save Annotation
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      </div>
    );
  }

  return null;
};

// Annotation Canvas Component
const AnnotationCanvas = ({ photo, canvasRef, drawTool, drawColor, drawThickness, annotations, setAnnotations }) => {
  const [startPos, setStartPos] = useState(null);
  const [isDrawing, setIsDrawing] = useState(false);
  const [currentShape, setCurrentShape] = useState(null);
  const imgRef = useRef(null);

  // Redraw all annotations
  const redrawCanvas = (includeCurrent = false) => {
    if (!canvasRef.current || !imgRef.current) return;

    const canvas = canvasRef.current;
    const ctx = canvas.getContext('2d');
    const img = imgRef.current;

    // Clear and redraw image
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0);

    // Draw all saved annotations
    annotations.forEach(ann => {
      ctx.strokeStyle = ann.color;
      ctx.lineWidth = ann.thickness;

      if (ann.type === 'circle') {
        ctx.beginPath();
        ctx.arc(ann.startX, ann.startY, ann.radius, 0, 2 * Math.PI);
        ctx.stroke();
      } else if (ann.type === 'line') {
        ctx.beginPath();
        ctx.moveTo(ann.startX, ann.startY);
        ctx.lineTo(ann.endX, ann.endY);
        ctx.stroke();
      } else if (ann.type === 'arrow') {
        drawArrow(ctx, ann.startX, ann.startY, ann.endX, ann.endY, ann.thickness);
      }
    });

    // Draw current shape being drawn
    if (includeCurrent && currentShape) {
      ctx.strokeStyle = drawColor;
      ctx.lineWidth = drawThickness;

      if (currentShape.type === 'circle') {
        ctx.beginPath();
        ctx.arc(currentShape.startX, currentShape.startY, currentShape.radius, 0, 2 * Math.PI);
        ctx.stroke();
      } else if (currentShape.type === 'line') {
        ctx.beginPath();
        ctx.moveTo(currentShape.startX, currentShape.startY);
        ctx.lineTo(currentShape.endX, currentShape.endY);
        ctx.stroke();
      } else if (currentShape.type === 'arrow') {
        drawArrow(ctx, currentShape.startX, currentShape.startY, currentShape.endX, currentShape.endY, drawThickness);
      }
    }
  };

  useEffect(() => {
    if (!canvasRef.current || !imgRef.current) return;

    const canvas = canvasRef.current;
    const img = imgRef.current;

    img.onload = () => {
      // Set canvas size to match image
      canvas.width = img.naturalWidth;
      canvas.height = img.naturalHeight;
      redrawCanvas();
    };

    img.src = photo.data;
  }, [photo, canvasRef]);

  // Redraw when annotations change
  useEffect(() => {
    redrawCanvas();
  }, [annotations]);

  const getMousePos = (e) => {
    const canvas = canvasRef.current;
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    
    return {
      x: (e.clientX - rect.left) * scaleX,
      y: (e.clientY - rect.top) * scaleY
    };
  };

  const handleMouseDown = (e) => {
    const pos = getMousePos(e);
    setStartPos(pos);
    setIsDrawing(true);
    setCurrentShape({
      type: drawTool,
      startX: pos.x,
      startY: pos.y,
      color: drawColor,
      thickness: drawThickness
    });
  };

  const handleMouseMove = (e) => {
    if (!isDrawing || !startPos) return;
    
    const currentPos = getMousePos(e);
    
    let shape = {
      ...currentShape,
      endX: currentPos.x,
      endY: currentPos.y
    };

    if (drawTool === 'circle') {
      const radius = Math.sqrt(
        Math.pow(currentPos.x - startPos.x, 2) + 
        Math.pow(currentPos.y - startPos.y, 2)
      );
      shape.radius = radius;
    }

    setCurrentShape(shape);
    redrawCanvas(true);
  };

  const handleMouseUp = (e) => {
    if (!isDrawing || !startPos) return;
    
    const currentPos = getMousePos(e);
    
    let finalShape = {
      type: drawTool,
      startX: startPos.x,
      startY: startPos.y,
      endX: currentPos.x,
      endY: currentPos.y,
      color: drawColor,
      thickness: drawThickness
    };

    if (drawTool === 'circle') {
      const radius = Math.sqrt(
        Math.pow(currentPos.x - startPos.x, 2) + 
        Math.pow(currentPos.y - startPos.y, 2)
      );
      finalShape.radius = radius;
    }

    // Save the shape
    setAnnotations([...annotations, finalShape]);
    
    setIsDrawing(false);
    setStartPos(null);
    setCurrentShape(null);
  };

  const drawArrow = (ctx, fromX, fromY, toX, toY, thickness) => {
    const headLength = 15 + (thickness * 2);
    const angle = Math.atan2(toY - fromY, toX - fromX);
    
    // Draw line
    ctx.beginPath();
    ctx.moveTo(fromX, fromY);
    ctx.lineTo(toX, toY);
    ctx.stroke();
    
    // Draw arrowhead
    ctx.beginPath();
    ctx.moveTo(toX, toY);
    ctx.lineTo(
      toX - headLength * Math.cos(angle - Math.PI / 6),
      toY - headLength * Math.sin(angle - Math.PI / 6)
    );
    ctx.moveTo(toX, toY);
    ctx.lineTo(
      toX - headLength * Math.cos(angle + Math.PI / 6),
      toY - headLength * Math.sin(angle + Math.PI / 6)
    );
    ctx.stroke();
  };

  return (
    <div className="relative border-2 border-gray-300 rounded overflow-hidden">
      <img ref={imgRef} src={photo.data} alt="Original" className="hidden" />
      <canvas
        ref={canvasRef}
        onMouseDown={handleMouseDown}
        onMouseMove={handleMouseMove}
        onMouseUp={handleMouseUp}
        onMouseLeave={() => setIsDrawing(false)}
        className="max-w-full h-auto cursor-crosshair"
        style={{ display: 'block', maxHeight: '500px' }}
      />
      <div className="absolute bottom-2 right-2 bg-black bg-opacity-50 text-white px-2 py-1 rounded text-xs">
        {annotations.length} annotation{annotations.length !== 1 ? 's' : ''}
      </div>
    </div>
  );
};

export default ChildDocumentationApp;

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(React.createElement(ChildDocumentationApp));
  </script>
</body>
</html>
